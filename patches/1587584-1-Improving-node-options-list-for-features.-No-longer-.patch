From 5d95ec1207d54da68575bff946dccbefc015a3ab Mon Sep 17 00:00:00 2001
From: James Andres <james.andres@gmail.com>
Date: Thu, 17 May 2012 14:10:16 -0400
Subject: [PATCH] Improving node options list for features. No longer bailing
 when some nodes without UUIDs are found.

---
 .../node_export_features.module                    |   45 +++++++++-----------
 1 file changed, 20 insertions(+), 25 deletions(-)

diff --git a/modules/node_export_features/node_export_features.module b/modules/node_export_features/node_export_features.module
index 87b876b..abcee6e 100755
--- a/modules/node_export_features/node_export_features.module
+++ b/modules/node_export_features/node_export_features.module
@@ -18,43 +18,38 @@ function node_export_features_features_api() {
  * Implementation of hook_features_export_options().
  */
 function node_export_features_features_export_options() {
-  static $loaded_nodes = 0;
-
   $options = array();
 
   $types = node_get_types('names');
-
-  $query = 'SELECT n.nid, n.title, n.type FROM {node} n';
-  $query .= ' ORDER BY n.type, n.title ASC';
-  $result = db_query($query);
+  $result = db_query("SELECT n.nid, n.title, n.type FROM {node} n ORDER BY n.type, n.title ASC");
+  $msg_printed = FALSE;
 
   while ($row = db_fetch_object($result)) {
-
     $uuid = uuid_get_uuid('node', 'nid', $row->nid);
-    // Create uuid if it doesn't exist.
+
+    // Skip nodes that have no UUID
     if (empty($uuid)) {
-      if ($loaded_nodes > 20) {
-        drupal_set_message("Too many nodes are missing UUID, therefore some nodes will not be available for features export. Repeatedly triggering this message will help this problem.", 'warning');
-        break;
-      }
-      else {
-        $node = node_load($row->nid);
-        $uuid = uuid_set_uuid('node', 'nid', $node->nid);
-        $node->uuid = $uuid;
-        // Save for consistency.
-        node_save($node);
-        $loaded_nodes++;
+      if (!$msg_printed) {
+        $msg_printed = TRUE;
+        drupal_set_message(t("Some nodes are <strong>not</strong> available for
+                              export because of missing UUIDs. Ensure
+                              UUIDs are being generated for all content types
+                              and click the <em>Create missing UUIDs</em> button
+                              on the <a href=\"!url\">UUID settings page</a>
+                              to help resolve this issue.", array(
+                                '!url' => url('admin/settings/uuid')
+                              )), 'warning');
       }
     }
-
-    $options[$uuid] = t('@type: @title', array(
-      '@type' => $types[$row->type],
-      '@title' => $row->title,
-    ));
+    else {
+      $options[$uuid] = t('@type: @title', array(
+        '@type' => $types[$row->type],
+        '@title' => $row->title,
+      ));
+    }
   }
 
   return $options;
-
 }
 
 /**
-- 
1.7.9.4

